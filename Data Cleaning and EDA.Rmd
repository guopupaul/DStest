---
title: "Data Cleaning and EDA"
output:
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

# Exploring the DOJCS prisoner statistics 2007-2018 - Prisoner Age and Imprisonment rate
## Introduction
Corrections Victoria has published its Annual Prisoner Statistical Profile 2007-2018 on the DOJCS website <https://www.corrections.vic.gov.au/publications-manuals-and-statistics/annual-prisoner-statistical-profile-2006-07-to-2017-18>. This consists of tables spread across 36 sheets of an Excel workbook. The profile is not in a tidy data format. The profile aggregates and displays data in many dimensions but it does not provide any visualisation or analysis.

## Cleaning the data - prisoner age
Data regarding prisoner age is in Table 1.5. The code blocks below tidy up the male and female data separately and then join them into one tidy data tibble showing prisoner age across the time period.

Load the following packages:
```{r}
library(stringr)
library(dplyr)
library(readxl)
library(tidyr)
library(lubridate)
library(ggplot2)
```

Here is the male data read in:
```{r}
male_prisoner_age <- read_excel("annual_prisonerstats_2017-18v2.xls", sheet = 8, range = "B6:AA15",col_names = FALSE)
```
Here is the female data read in:
```{r}
female_prisoner_age <- read_excel("annual_prisonerstats_2017-18v2.xls", sheet = 8, range = "B21:AA30",col_names = FALSE)
```
The code below is a function that tidies the extracted data:
```{r}
tidy_age <- function(x) {
#remove column 2 (blank) and percentage columns
x <- x %>% select(1,3:26) %>% select(c(-3, -5, -7, -9, -11, -13, -15, -17, -19, -21, -23, -25 ))
# label age and dates
colnames(x) <- c("Age", "30/06/07", "30/06/08", "30/06/09", "30/06/10", "30/06/11", "30/06/12", "30/06/13", "30/06/14", "30/06/15", "30/06/16", "30/06/17", "30/06/18")
#transpose rows and columns
x <- x %>% gather("year", "number_of_prisoners", 2:13)
}
```
A tidy data tibble showing male prisoner age across 2007-2018:
```{r}
tidy_male_prisoner_age <- tidy_age(male_prisoner_age)
tidy_male_prisoner_age
```
A tidy data tibble showing female prisoner age across 2007-2018:
```{r}
tidy_female_prisoner_age <- tidy_age(female_prisoner_age)
tidy_female_prisoner_age
```
The code below joins male and female tibbles together:
```{r}
tidy_male_prisoner_age <- tidy_male_prisoner_age %>% mutate(gender = "Male")
tidy_female_prisoner_age <- tidy_female_prisoner_age %>% mutate(gender = "Female")
#join the two tibbles
tidy_prisoner_age <- tidy_male_prisoner_age %>%
bind_rows(tidy_female_prisoner_age) 
#consistent variable names and column order for presentation
tidy_prisoner_age <- tidy_prisoner_age %>% 
mutate_all(list(~str_replace(.,"Under 20", "0-20" ))) %>% 
mutate_all(list(~str_replace(.,"60 and over", "60-150" ))) 
tidy_prisoner_age$year <- dmy(tidy_prisoner_age$year)
tidy_prisoner_age$number_of_prisoners <- as.numeric(tidy_prisoner_age$number_of_prisoners)
tidy_prisoner_age <- tidy_prisoner_age %>% arrange(year)
col_order <- c("Age", "gender", "year", "number_of_prisoners")
tidy_prisoner_age <- tidy_prisoner_age[, col_order]
#define the set for EDA
prisoner.age <- tidy_prisoner_age
```
## Cleaning the data - Imprisonment rate
Data regarding Imprisonment Rate is in Table 1.6. The code blocks below tidy up the male and female data separately and then join them into one tidy data tibble showing Imprisonment Rate across the time period.

Here is the male data read in:
```{r}
male_prisoner_rate <- read_excel("annual_prisonerstats_2017-18v2.xls", sheet = 9, range = "B6:O16",col_names = FALSE)
```
Here is the female data read in:
```{r}
female_prisoner_rate <- read_excel("annual_prisonerstats_2017-18v2.xls", sheet = 9, range = "B21:O31",col_names = FALSE)
```
The code below is a function that tidies the extracted data:
```{r}
tidy_rate <- function(x) {
#remove column 2 (blank)
x <- x %>% select(1,3:14)
# label Rate and dates
colnames(x) <- c("Age", "30/06/07", "30/06/08", "30/06/09", "30/06/10", "30/06/11", "30/06/12", "30/06/13", "30/06/14", "30/06/15", "30/06/16", "30/06/17", "30/06/18")
#transpose rows and columns
x <- x %>% gather("year", "rate_per_100K", 2:13)
}
```
A tidy data tibble showing male prisoner Rate across 2007-2018:
```{r}
tidy_male_prisoner_rate <- tidy_rate(male_prisoner_rate)
tidy_male_prisoner_rate
```
A tidy data tibble showing female prisoner Rate across 2007-2018:
```{r}
tidy_female_prisoner_rate <- tidy_rate(female_prisoner_rate)
tidy_female_prisoner_rate
```
The code below joins male and female tibbles together:
```{r}
tidy_male_prisoner_rate <- tidy_male_prisoner_rate %>% mutate(gender = "Male")
tidy_female_prisoner_rate <- tidy_female_prisoner_rate %>% mutate(gender = "Female")
#join the two tibbles
tidy_prisoner_rate <- tidy_male_prisoner_rate %>%
bind_rows(tidy_female_prisoner_rate) %>%
arrange(year)
#consistent variable names, classes and column order for presentation
tidy_prisoner_rate <- tidy_prisoner_rate %>% 
mutate_all(list(~str_replace(.,"Under 20", "0-20" ))) %>% 
mutate_all(list(~str_replace(.,"65 and over", "60-150" )))
tidy_prisoner_rate$year <- dmy(tidy_prisoner_rate$year)
tidy_prisoner_rate$rate_per_100K <- as.numeric(tidy_prisoner_rate$rate_per_100K)
tidy_prisoner_rate <- tidy_prisoner_rate %>% arrange(year)
col_order <- c("Age", "gender", "year", "rate_per_100K")
tidy_prisoner_rate <- tidy_prisoner_rate[, col_order]
```
## Consolidating Age and Imprisonment rate data
For reasons unknown, the age bin values in "Prisoner Age"" stop at 60, but they stop at 65 in "Imprisonment Rate".To consolidate this data alongside the age data, we need to combine the "60-64"" and "65 and Over" rates into a comparable "60-150" bin.
```{r}
#select values to be combined
f <- tidy_prisoner_rate %>% filter(Age %in% c("60-64","60-150")) 
#combine rates
g <- f %>% group_by(year, gender) %>% summarise(rate_per_100K = sum(rate_per_100K))
#create a "matching tibble"
h <- g %>% mutate(Age = "60-150")
col_order <- c("Age", "gender", "year", "rate_per_100K")
h <- h[, col_order]
h
#remove "unwanted values" from tidy_prisoner_rate
tidy_prisoner_rate <- tidy_prisoner_rate %>% filter(!Age %in% c("60-64","60-150")) %>%
#join the consolidated data
bind_rows(h) %>% arrange(year)
#define the set for EDA
imprisonment.rate <- tidy_prisoner_rate
```
HERE IS A TIDY DATA TIBBLE FOR AGE AND IMPRISONMENT RATES
```{r}
prisoners <- prisoner.age %>% left_join(imprisonment.rate, by = c("Age", "gender", "year"))
prisoners
```
##Cleaning the data - prisoner profile
The DOJCS workbook has several sheets that profile prisoners during the time period. These are:
Table 1.7 Known prior adult imprisonment
Table 1.8 Sentenced/Unsentenced
Table 1.11 Most serious charge/offence
Table 1.12 Country of birth
Table 1.13 Highest level of education
Table 1.14 Employment status
Table 1.15 Marital Status
 The code blocks below tidy up the data separately and then join them into one tidy data tibble showing prisoner profile across the time period.
The range layout for profile factors varies across the workbook. Known priors, charge/offence, education, employment and marital status all work off the function designed for prisoner age. Sentenced and unsentenced require altered functions.
 

 # Known prior adult imprisonment
Here is the male data read in:
```{r}
male_prisoner_prior <- read_excel("annual_prisonerstats_2017-18v2.xls", sheet = 10, range = "B7:AA12",col_names = FALSE)
```
Here is the female data read in:
```{r}
female_prisoner_prior <- read_excel("annual_prisonerstats_2017-18v2.xls", sheet = 10, range = "B17:AA22",col_names = FALSE)
```
A tidy data tibble for male priors
```{r}
tidy_male_prisoner_prior <- tidy_age(male_prisoner_prior) %>%
rename( "Priors" = "Age")
tidy_male_prisoner_prior
```
A tidy data tibble for female priors
```{r}
tidy_female_prisoner_prior <- tidy_age(female_prisoner_prior) %>%
rename( "Priors" = "Age")
tidy_female_prisoner_prior
```
The code below joins male and female tibbles together:
```{r}
tidy_male_prisoner_prior <- tidy_male_prisoner_prior %>% mutate(gender = "Male")
tidy_female_prisoner_prior <- tidy_female_prisoner_prior %>% mutate(gender = "Female")
#join the two tibbles
tidy_prisoner_prior <- tidy_male_prisoner_prior %>%
bind_rows(tidy_female_prisoner_prior) 
#consistent classes and column order for presentation
tidy_prisoner_prior$year <- dmy(tidy_prisoner_prior$year)
tidy_prisoner_prior$number_of_prisoners <- as.numeric(tidy_prisoner_prior$number_of_prisoners)
tidy_prisoner_prior <- tidy_prisoner_prior %>% arrange(year)
col_order <- c("Priors", "gender", "year", "number_of_prisoners")
tidy_prisoner_prior <- tidy_prisoner_prior[, col_order]
#define the set for EDA
prisoner.priors <- tidy_prisoner_prior
prisoner.priors
```
#Most serious offence
Here is the male data read in:
```{r}
male_prisoner_offence <- read_excel("annual_prisonerstats_2017-18v2.xls", sheet = 14, range = "B6:AA17",col_names = FALSE)
```
Here is the female data read in:
```{r}
female_prisoner_offence <- read_excel("annual_prisonerstats_2017-18v2.xls", sheet = 14, range = "B22:AA33",col_names = FALSE)
```
A tidy data tibble for male offences
```{r}
tidy_male_prisoner_offence <- tidy_age(male_prisoner_offence) %>%
rename( "Offence" = "Age")
tidy_male_prisoner_offence
```
A tidy data tibble for female offences
```{r}
tidy_female_prisoner_offence <- tidy_age(female_prisoner_offence) %>%
rename( "Offence" = "Age")
tidy_female_prisoner_offence
```
The code below joins male and female tibbles together:
```{r}
tidy_male_prisoner_offence <- tidy_male_prisoner_offence %>% mutate(gender = "Male")
tidy_female_prisoner_offence <- tidy_female_prisoner_offence %>% mutate(gender = "Female")
#join the two tibbles
tidy_prisoner_offence <- tidy_male_prisoner_offence %>%
bind_rows(tidy_female_prisoner_offence) 
#consistent classes and column order for presentation
tidy_prisoner_offence$year <- dmy(tidy_prisoner_offence$year)
tidy_prisoner_offence$number_of_prisoners <- as.numeric(tidy_prisoner_offence$number_of_prisoners)
tidy_prisoner_offence <- tidy_prisoner_offence %>% arrange(year)
col_order <- c("Offence", "gender", "year", "number_of_prisoners")
tidy_prisoner_offence <- tidy_prisoner_offence[, col_order]
#define the set for EDA
prisoner.offences <- tidy_prisoner_offence
prisoner.offences
```




 # Aboriginal and Torres Strait Islander prisoners
Here is the male data read in:
```{r}
male_prisoner_ATSI <- read_excel("annual_prisonerstats_2017-18v2.xls", sheet = 7, range = "B8:O8",col_names = FALSE)
```
Here is the female data read in:
```{r}
female_prisoner_ATSI <- read_excel("annual_prisonerstats_2017-18v2.xls", sheet = 7, range = "B11:O11",col_names = FALSE)
```
